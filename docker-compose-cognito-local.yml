# cognito-localを使ったOAuth2認証付きRundeck HA構成
services:
  nginx:
    image: nginx:alpine
    ports:
      - "9000:80"
      - "9443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./nginx/ssl:/etc/nginx/ssl
    depends_on:
      - oauth2-proxy
      - backend
    networks:
      - oauth-network
    restart: unless-stopped

  # cognito-local - 本格的なAWS Cognito エミュレーター
  cognito-local:
    image: jagregory/cognito-local:latest
    ports:
      - "9229:9229"  # Cognito Local API
    environment:
      - HOST=0.0.0.0
      - PORT=9229
      - COGNITO_LOCAL_PORT=9229
    volumes:
      - cognito-local-data:/app/.cognito
    networks:
      - oauth-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9229/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s

  # OAuth2 Proxy - cognito-local OIDC連携設定
  oauth2-proxy:
    image: quay.io/oauth2-proxy/oauth2-proxy:latest
    ports:
      - "4181:4180"
    environment:
      - OAUTH2_PROXY_PROVIDER=oidc
      - OAUTH2_PROXY_OIDC_ISSUER_URL=http://cognito-local:9229/local_2JfyZzqC
      - OAUTH2_PROXY_INSECURE_OIDC_SKIP_ISSUER_VERIFICATION=true
      - OAUTH2_PROXY_INSECURE_OIDC_ALLOW_UNVERIFIED_EMAIL=true
      - OAUTH2_PROXY_CLIENT_ID=rundeck-client
      - OAUTH2_PROXY_CLIENT_SECRET=rundeck-client-secret
      - OAUTH2_PROXY_EMAIL_DOMAINS=*
      - OAUTH2_PROXY_UPSTREAM=http://backend:8080
      - OAUTH2_PROXY_HTTP_ADDRESS=0.0.0.0:4180
      - OAUTH2_PROXY_REDIRECT_URL=http://localhost:9000/oauth2/callback
      - OAUTH2_PROXY_COOKIE_SECURE=false
      - OAUTH2_PROXY_COOKIE_HTTPONLY=true
      - OAUTH2_PROXY_SET_XAUTHREQUEST=true
      - OAUTH2_PROXY_PASS_ACCESS_TOKEN=true
      - OAUTH2_PROXY_PASS_USER_HEADERS=true
      - OAUTH2_PROXY_SCOPE=openid email profile
      - OAUTH2_PROXY_COOKIE_SECRET=VHYjkHPUrFYM8w8SG3BVnCJfKxBS61JF
      - OAUTH2_PROXY_SKIP_OIDC_DISCOVERY=false
      - OAUTH2_PROXY_INSECURE_OIDC_ALLOW_UNVERIFIED_EMAIL=true
    depends_on:
      - cognito-local
      - backend
    networks:
      - oauth-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:4180/ping"]
      interval: 30s
      timeout: 10s
      retries: 3

  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    ports:
      - "8090:8080"
    environment:
      - PORT=8080
      - COGNITO_REGION=us-east-1
      - COGNITO_USER_POOL_ID=us-east-1_rundeck
      - COGNITO_CLIENT_ID=rundeck-client
      - COGNITO_ENDPOINT=http://cognito-local:9229
    depends_on:
      - cognito-local
    networks:
      - oauth-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # PostgreSQL Database for Rundeck HA
  rundeck-postgres:
    image: postgres:15-alpine
    environment:
      - POSTGRES_DB=rundeck
      - POSTGRES_USER=rundeck
      - POSTGRES_PASSWORD=rundeck123
      - POSTGRES_INITDB_ARGS=--encoding=UTF8 --locale=C
    volumes:
      - rundeck-postgres-data:/var/lib/postgresql/data
    networks:
      - oauth-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U rundeck -d rundeck"]
      interval: 30s
      timeout: 10s
      retries: 5

  # Rundeck Active Node
  rundeck-active:
    image: rundeck/rundeck:5.14.0-20250804
    ports:
      - "4444:4440"
    environment:
      - RUNDECK_GRAILS_URL=http://localhost:9000/rundeck
      - RUNDECK_SERVER_FORWARDED=true
      - RUNDECK_LOGGING_STRATEGY=CONSOLE
      - RUNDECK_DATABASE_DRIVER=org.postgresql.Driver
      - RUNDECK_DATABASE_USERNAME=rundeck
      - RUNDECK_DATABASE_PASSWORD=rundeck123
      - RUNDECK_DATABASE_URL=jdbc:postgresql://rundeck-postgres:5432/rundeck
      - RUNDECK_PLUGIN_PROVISIONING_ENABLED=true
      - RUNDECK_SERVER_UUID=e7dcae5b-7bbd-4169-bc44-ddd7ec0f3d1a
      - RUNDECK_QUARTZ_JOB_STORE_DELEGATE_CLASS=org.quartz.impl.jdbcjobstore.PostgreSQLDelegate
      - RUNDECK_QUARTZ_JOB_STORE_CLASS=org.springframework.scheduling.quartz.LocalDataSourceJobStore
      - RUNDECK_QUARTZ_JOB_STORE_IS_CLUSTERED=true
      - RUNDECK_QUARTZ_JOB_STORE_CLUSTER_CHECKIN_INTERVAL=20000
      - RUNDECK_PREAUTH_ENABLED=true
      - RUNDECK_PREAUTH_ATTRIBUTE_NAME=REMOTE_USER_EMAIL
      - RUNDECK_PREAUTH_DELIMITER=,
      - RUNDECK_PREAUTH_USERNAME_HEADER=X-Auth-Request-Email
      - RUNDECK_PREAUTH_ROLES_HEADER=X-Auth-Request-Roles
      - RUNDECK_PREAUTH_REDIRECT_LOGOUT=http://localhost:9000/oauth2/sign_out
      - RUNDECK_PREAUTH_USER_FIRST_NAME_HEADER=X-Auth-Request-Given-Name
      - RUNDECK_PREAUTH_USER_LAST_NAME_HEADER=X-Auth-Request-Family-Name
      - GRAILS_ASSETS_MINIFIED=false
      - GRAILS_ASSETS_PLUGIN_BOOTSTRAP_ENABLED=false
      - RUNDECK_STATIC_ASSETS_PATH=/home/rundeck/user-assets
      - RUNDECK_GRAILS_SERVER_URL=http://localhost:9000/rundeck
    volumes:
      - rundeck-shared-data:/home/rundeck/server/data
      - ./rundeck/config:/home/rundeck/server/config
    depends_on:
      - rundeck-postgres
      - backend
    networks:
      - oauth-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4440/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

  # Rundeck Standby Node
  rundeck-standby:
    image: rundeck/rundeck:5.14.0-20250804
    ports:
      - "4445:4440"
    environment:
      - RUNDECK_GRAILS_URL=http://localhost:9000/rundeck
      - RUNDECK_SERVER_FORWARDED=true
      - RUNDECK_LOGGING_STRATEGY=CONSOLE
      - RUNDECK_DATABASE_DRIVER=org.postgresql.Driver
      - RUNDECK_DATABASE_USERNAME=rundeck
      - RUNDECK_DATABASE_PASSWORD=rundeck123
      - RUNDECK_DATABASE_URL=jdbc:postgresql://rundeck-postgres:5432/rundeck
      - RUNDECK_PLUGIN_PROVISIONING_ENABLED=true
      - RUNDECK_SERVER_UUID=ffe48a7c-a882-4864-a2a3-c8842d1ed4e2
      - RUNDECK_QUARTZ_JOB_STORE_DELEGATE_CLASS=org.quartz.impl.jdbcjobstore.PostgreSQLDelegate
      - RUNDECK_QUARTZ_JOB_STORE_CLASS=org.springframework.scheduling.quartz.LocalDataSourceJobStore
      - RUNDECK_QUARTZ_JOB_STORE_IS_CLUSTERED=true
      - RUNDECK_QUARTZ_JOB_STORE_CLUSTER_CHECKIN_INTERVAL=20000
      - RUNDECK_PREAUTH_ENABLED=true
      - RUNDECK_PREAUTH_ATTRIBUTE_NAME=REMOTE_USER_EMAIL
      - RUNDECK_PREAUTH_DELIMITER=,
      - RUNDECK_PREAUTH_USERNAME_HEADER=X-Auth-Request-Email
      - RUNDECK_PREAUTH_ROLES_HEADER=X-Auth-Request-Roles
      - RUNDECK_PREAUTH_REDIRECT_LOGOUT=http://localhost:9000/oauth2/sign_out
      - RUNDECK_PREAUTH_USER_FIRST_NAME_HEADER=X-Auth-Request-Given-Name
      - RUNDECK_PREAUTH_USER_LAST_NAME_HEADER=X-Auth-Request-Family-Name
      - GRAILS_ASSETS_MINIFIED=false
      - GRAILS_ASSETS_PLUGIN_BOOTSTRAP_ENABLED=false
      - RUNDECK_STATIC_ASSETS_PATH=/home/rundeck/user-assets
      - RUNDECK_GRAILS_SERVER_URL=http://localhost:9000/rundeck
    volumes:
      - rundeck-shared-data:/home/rundeck/server/data
      - ./rundeck/config:/home/rundeck/server/config
    depends_on:
      - rundeck-postgres
      - backend
    networks:
      - oauth-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4440/health"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s

volumes:
  cognito-local-data:
  rundeck-postgres-data:
  rundeck-shared-data:

networks:
  oauth-network:
    driver: bridge
